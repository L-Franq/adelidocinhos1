<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <title>Agenda Confeitaria</title>

    <style>
      body {
        font-family: Arial, sans-serif;
      }
      #calendar {
        max-width: 900px;
        margin: 40px auto;
      }
    </style>
  </head>
  <body>
    <div id="calendar"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const calendarEl = document.getElementById("calendar");

        let agenda = {};

        const coresTurno = {
          manha: "#FFA500",
          tarde: "#1E90FF",
          noite: "#32CD32",
        };

        function criarDia() {
          return {
            slots: {
              manha: null,
              tarde: null,
              noite: null,
            },
            espera: [],
          };
        }

        function diaCheio(dia) {
          return Object.values(dia.slots).every((slot) => slot !== null);
        }

        function podeEntrarEspera(dia) {
          return dia.espera.length < 2;
        }

        function atualizarDiaVisual(calendar, data, dia) {
          // remover eventos antigos do dia
          calendar.getEvents().forEach((event) => {
            if (event.startStr === data) {
              event.remove();
            }
          });

          // eventos dos turnos
          for (const turno in dia.slots) {
            if (dia.slots[turno]) {
              calendar.addEvent({
                title: `Ocupado (${turno})`,
                start: data,
                allDay: true,
                backgroundColor: coresTurno[turno],
              });
            }
          }

          // espera
          if (dia.espera.length > 0) {
            calendar.addEvent({
              title: `‚è≥ Espera: ${dia.espera.length}`,
              start: data,
              allDay: true,
              backgroundColor: "#999",
            });
          }

          // bloqueio
          if (diaCheio(dia)) {
            calendar.addEvent({
              title: "üîí Dia bloqueado",
              start: data,
              allDay: true,
              backgroundColor: "#333",
            });
          }
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",

          dateClick(info) {
            const data = info.dateStr;

            if (!agenda[data]) {
              agenda[data] = criarDia();
            }

            const dia = agenda[data];

            const turno = prompt("Escolha o turno: manha, tarde ou noite");

            if (!dia.slots.hasOwnProperty(turno)) return;

            if (dia.slots[turno] === null) {
              dia.slots[turno] = "turno ocupado";

              calendar.addEvent({
                title: `Ocupado (${turno})`,
                start: data,
                allDay: true,
                backgroundColor: coresTurno[turno],
              });
            } else if (podeEntrarEspera(dia)) {
              dia.espera.push("user");
            }
            else{
              alert("Dia Lotado");
            }

            atualizarDiaVisual(calendar, data, dia);

            console.log(agenda);
          },
        });
        calendar.render();
      });
    </script>
  </body>
</html>
